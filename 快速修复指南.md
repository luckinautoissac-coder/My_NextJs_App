# 🚀 快速修复 - 数据持久化问题

## ⚡ 三步修复

### 第一步：执行数据库脚本（仅云端模式）

**如果您配置了 Supabase**：

1. 登录 [Supabase 控制台](https://supabase.com/dashboard)
2. 选择您的项目
3. 点击左侧 **SQL Editor**
4. 复制粘贴以下代码并执行：

```sql
CREATE TABLE IF NOT EXISTS folders (
  id VARCHAR(255) PRIMARY KEY,
  user_id VARCHAR(255) NOT NULL,
  name VARCHAR(255) NOT NULL,
  agent_id VARCHAR(255) NOT NULL,
  is_expanded BOOLEAN DEFAULT true,
  "order" INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_folders_user_id ON folders(user_id);
CREATE INDEX IF NOT EXISTS idx_folders_agent_id ON folders(agent_id);
CREATE INDEX IF NOT EXISTS idx_folders_user_agent ON folders(user_id, agent_id);

ALTER TABLE topics 
ADD COLUMN IF NOT EXISTS folder_id VARCHAR(255);

CREATE INDEX IF NOT EXISTS idx_topics_folder_id ON topics(folder_id);
```

5. 点击 **Run** 按钮
6. 看到成功提示即可

**如果您没有配置 Supabase**：跳过此步骤

---

### 第二步：重启应用

在项目目录打开命令行，执行：

```bash
# 如果应用正在运行，先按 Ctrl+C 停止

# 重新启动
npm run dev
```

---

### 第三步：验证修复

1. 在应用中创建一个新文件夹
2. 刷新浏览器页面
3. 检查文件夹是否还在 ✅
4. 关闭浏览器，重新打开
5. 再次检查数据是否保留 ✅

---

## ✅ 修复完成！

现在您可以：
- ✅ 关机重启 - 数据不会丢失
- ✅ 刷新页面 - 数据不会丢失
- ✅ 整理文件夹 - 顺序会保存
- ✅ 跨设备使用 - 数据会同步（云端模式）

---

## 🆘 遇到问题？

### 问题 1：执行 SQL 脚本时报错

**解决方法**：
- 检查是否正确连接到 Supabase 项目
- 确认您有数据库管理权限
- 查看具体错误信息

### 问题 2：重启后数据还是丢失

**解决方法**：
1. 打开浏览器开发者工具（F12）
2. 查看 Console 标签
3. 查找是否有红色错误信息
4. 检查是否显示 "☁️ [云端模式]" 或 "💾 [本地模式]"

### 问题 3：文件夹没有同步到云端

**可能原因**：
- Supabase 未正确配置
- 网络连接问题
- 数据库表未创建

**检查方法**：
1. 查看浏览器控制台是否有 "❌" 错误提示
2. 登录 Supabase → Table Editor → 检查是否有 `folders` 表
3. 确认环境变量是否正确设置

---

## 📝 技术说明

### 修复了什么？

**原来的问题**：
- 文件夹只保存在浏览器 localStorage
- 清除浏览器数据会导致文件夹丢失

**现在的方案**：
- 文件夹同时保存在 localStorage 和云端数据库
- 双层备份机制，数据更安全

### 修改了哪些文件？

1. ✅ 新建 `src/app/api/folders/route.ts` - 文件夹 API
2. ✅ 更新 `src/lib/supabase.ts` - 添加文件夹函数
3. ✅ 更新 `src/store/topicStore.ts` - 支持云端同步
4. ✅ 新建 `数据库表结构-文件夹表.sql` - 数据库脚本

---

**最后更新**: 2026-02-27

